<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folder Watcher Settings - Sonarr-Seedr Integration</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <script src="../static/js/app.js"></script>
</head>

<body>
    <div class="navbar">
        <div>
            <a href="/">Dashboard</a>
            <a href="/torrents">Torrents</a>
            <a href="/config">Config</a>
            <a href="/folder-watcher" class="active">Folder Watcher</a>
        </div>
        <div>
            <a href="/api/auth/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Folder Watcher Settings</h1>
            <div class="nav-links">
                <a href="/" title="Dashboard"><i class="icon">üè†</i></a>
                <a href="/config" title="Configuration"><i class="icon">‚öôÔ∏è</i></a>
            </div>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-success">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Status indicator -->
        <div class="status-card {% if is_running %}status-running{% else %}status-stopped{% endif %}">
            <div class="status-icon">
                <span
                    class="status-indicator {% if is_running %}indicator-running{% else %}indicator-stopped{% endif %}"></span>
            </div>
            <div class="status-text">
                <h3>Watcher Status</h3>
                <p>The folder watcher is currently <strong>{% if is_running %}Running{% else %}Stopped{% endif
                        %}</strong></p>
            </div>
        </div>

        <!-- Auto-start note -->
        <div class="info-card">
            <div class="info-icon">‚ÑπÔ∏è</div>
            <div class="info-content">
                <p>When configured, the folder watcher will automatically start when the application launches.
                    You only need to manually start it if it was stopped or if you want to apply new settings.</p>
            </div>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab-button active" data-tab="settings">Settings</button>
                <button class="tab-button" data-tab="status">Status</button>
            </div>

            <div class="tab-content">
                <div id="settings-tab" class="tab-pane active">
                    <div class="config-container">
                        <form method="POST" action="/api/watcher/config">
                            <div class="form-group">
                                <label for="torrent_dir">Torrent Directory</label>
                                <div class="input-group">
                                    <input type="text" id="torrent_dir" name="torrent_dir" class="form-control"
                                        value="{{ settings.torrent_dir if settings else '' }}" required>
                                    <button type="button" class="button browse-btn"
                                        onclick="browseFolders('torrent_dir')">Browse</button>
                                </div>
                                <small class="form-text">Directory where the .torrent files will be placed by
                                    Sonarr</small>
                            </div>

                            <div class="form-group">
                                <label for="download_dir">Download Directory</label>
                                <div class="input-group">
                                    <input type="text" id="download_dir" name="download_dir" class="form-control"
                                        value="{{ settings.download_dir if settings else '' }}" required>
                                    <button type="button" class="button browse-btn"
                                        onclick="browseFolders('download_dir')">Browse</button>
                                </div>
                                <small class="form-text">Directory where downloaded files from Seedr will be
                                    saved</small>
                            </div>

                            <div class="form-group">
                                <label for="watch_interval">Watch Interval (seconds)</label>
                                <input type="number" id="watch_interval" name="watch_interval" class="form-control"
                                    value="{{ settings.watch_interval if settings else 30 }}" min="10" max="300">
                                <small class="form-text">How often to check for download status (10-300 seconds)</small>
                            </div>

                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="save_magnet_files" name="save_magnet_files"
                                    class="form-checkbox" {% if settings and settings.save_magnet_files %}checked{%
                                    endif %}>
                                <label for="save_magnet_files">Save Magnet Files</label>
                                <small class="form-text">Enable support for .magnet files</small>
                            </div>

                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="auto_start" name="auto_start" class="form-checkbox" checked>
                                <label for="auto_start">Auto-start Watcher</label>
                                <small class="form-text">Automatically start the watcher when the application
                                    launches</small>
                            </div>

                            <div class="form-group">
                                <label for="magnet_extension">Magnet File Extension</label>
                                <input type="text" id="magnet_extension" name="magnet_extension" class="form-control"
                                    value="{{ settings.magnet_extension if settings else '.magnet' }}">
                                <small class="form-text">Extension to use for magnet links (default: .magnet)</small>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="button primary">Save Settings</button>
                                <input type="hidden" name="start_watcher" value="false" id="start_watcher_input">
                                <button type="button" onclick="submitWithStart()" class="button secondary">Save & Start
                                    Watcher</button>
                            </div>
                        </form>
                    </div>

                    <div class="control-buttons">
                        <form method="POST" action="/api/watcher/start" style="display: inline-block;">
                            <input type="hidden" name="torrent_dir"
                                value="{{ settings.torrent_dir if settings and settings.torrent_dir else '' }}">
                            <input type="hidden" name="download_dir"
                                value="{{ settings.download_dir if settings and settings.download_dir else '' }}">
                            <button type="submit" class="button primary" {% if is_running %}disabled{% endif %}>
                                <i class="icon">‚ñ∂Ô∏è</i> Start Watcher
                            </button>
                        </form>
                        <form method="POST" action="/api/watcher/stop" style="display: inline-block;">
                            <button type="submit" class="button danger" {% if not is_running %}disabled{% endif %}>
                                <i class="icon">‚èπÔ∏è</i> Stop Watcher
                            </button>
                        </form>
                    </div>
                </div>

                <div id="status-tab" class="tab-pane">
                    <div class="config-container">
                        <h2>Watcher Configuration</h2>

                        <div class="status-grid">
                            <div class="status-item">
                                <div class="status-label">Torrent Directory</div>
                                <div class="status-value">
                                    {{ settings.torrent_dir if settings and settings.torrent_dir else 'Not configured'
                                    }}
                                </div>
                            </div>

                            <div class="status-item">
                                <div class="status-label">Download Directory</div>
                                <div class="status-value">
                                    {{ settings.download_dir if settings and settings.download_dir else 'Not configured'
                                    }}
                                </div>
                            </div>

                            <div class="status-item">
                                <div class="status-label">Watch Interval</div>
                                <div class="status-value">
                                    {{ settings.watch_interval if settings and settings.watch_interval else '30' }}
                                    seconds
                                </div>
                            </div>

                            <div class="status-item">
                                <div class="status-label">Process Magnet Files</div>
                                <div class="status-value">
                                    {% if settings and settings.save_magnet_files %}
                                    <span class="badge badge-success">Enabled</span>
                                    {% else %}
                                    <span class="badge badge-secondary">Disabled</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="status-item">
                                <div class="status-label">Auto-start on Launch</div>
                                <div class="status-value">
                                    <span class="badge badge-success">Enabled</span>
                                </div>
                            </div>
                        </div>

                        <h3>Activity Log</h3>
                        <div class="log-container">
                            <pre id="activity-log">{{ activity_log if activity_log else 'No recent activity' }}</pre>
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="refreshLog()" class="button primary">
                                <i class="icon">üîÑ</i> Refresh Log
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Folder browser overlay -->
    <div class="overlay" id="overlay"></div>
    <div class="folder-browser" id="folder-browser">
        <h3>Select a folder</h3>
        <div class="current-path" id="current-path"></div>
        <div class="folder-list" id="folder-list"></div>
        <div class="browser-actions">
            <button id="select-folder" class="button primary">Select</button>
            <button onclick="closeFolderBrowser()" class="button">Cancel</button>
        </div>
    </div>

    <script>
        let currentPath = '';

        // Tab switching
        document.addEventListener('DOMContentLoaded', function () {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Remove active class from all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

                    // Add active class to current tab
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });

            // Set up select folder button event
            document.getElementById('select-folder').addEventListener('click', function () {
                const targetInputId = this.dataset.targetInput;
                if (targetInputId && currentPath) {
                    document.getElementById(targetInputId).value = currentPath;
                    closeFolderBrowser();
                }
            });
        });

        // Function to submit form with start watcher set to true
        function submitWithStart() {
            document.getElementById('start_watcher_input').value = 'true';
            document.querySelector('form').submit();
        }

        // Show folder browser popup when user clicks browse button
        function browseFolders(inputId) {
            document.getElementById('overlay').classList.add('active');
            document.getElementById('folder-browser').classList.add('active');
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('folder-browser').style.display = 'block';

            // Store the input field ID for later use
            document.getElementById('select-folder').dataset.targetInput = inputId;

            // Start with current path from input if it exists, otherwise load drives
            const inputValue = document.getElementById(inputId).value;
            if (inputValue) {
                loadFolders(inputValue);
            } else {
                // Start with root or drives listing
                loadFolders('');
            }
        }

        // Close folder browser popup
        function closeFolderBrowser() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('folder-browser').classList.remove('active');
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('folder-browser').style.display = 'none';
            }, 300);
        }

        // Load folders from the server
        function loadFolders(path) {
            currentPath = path;
            document.getElementById('current-path').textContent = path || 'Select Drive';

            // Show loading indicator
            const folderList = document.getElementById('folder-list');
            folderList.innerHTML = '<div class="loading-folder">Loading folders...</div>';

            // Call the API to get folders
            fetch(`/api/filesystem/folders?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    folderList.innerHTML = '';

                    // If we're in a subfolder, add parent directory option
                    if (path) {
                        const parentFolder = document.createElement('div');
                        parentFolder.className = 'folder parent';
                        parentFolder.textContent = '.. (Parent Directory)';
                        parentFolder.onclick = () => {
                            // Go to parent directory
                            const parentPath = path.split('\\').slice(0, -1).join('\\');
                            loadFolders(parentPath);
                        };
                        folderList.appendChild(parentFolder);
                    }

                    // Add folders to the list
                    if (data.folders && data.folders.length > 0) {
                        data.folders.forEach(folder => {
                            const folderElement = document.createElement('div');
                            folderElement.className = 'folder';
                            folderElement.textContent = folder;

                            // Create full path for this folder
                            const fullPath = path ? `${path}\\${folder}` : folder;

                            folderElement.onclick = () => loadFolders(fullPath);
                            folderList.appendChild(folderElement);
                        });
                    } else {
                        folderList.innerHTML = '<div class="empty-folder">No folders found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading folders:', error);
                    folderList.innerHTML = '<div class="error-folder">Error loading folders</div>';
                });
        }

        // Function to refresh log
        function refreshLog() {
            fetch('/api/watcher/logs?lines=50')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.logs) {
                        document.getElementById('activity-log').textContent = data.logs.join('');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing logs:', error);
                });
        }
    </script>
</body>

</html>